version: 0.0.{build}

branches:
  only:
    - master
skip_tags: true
pull_requests:
  do_not_increment_build_number: false
  
max_jobs: 1

clone_folder: C:\wapo-data-police-shootings

environment:
  my_variable:
    secure: VANUwPuFnS9gOTlQKMEUU2S2/y2do5xnwKFmeDDhfjUVm06fGyAdqRLhb+T2QJQz

  MSSQL_LOGIN: sa
  MSSQL_PASS: Password12!
  
  matrix:
  #- APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2019
  #  MSSQL: SQL2019
  #  DB_INSTANCE: (local)\SQL2019
    
  #- APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #  MSSQL: SQL2017
  #  DB_INSTANCE: (local)\SQL2017
    
  #- APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2017
  #  MSSQL: SQL2016
  #  DB_INSTANCE: (local)\SQL2016
    
  #- APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
  #  MSSQL: SQL2014
  #  DB_INSTANCE: (local)\SQL2014
    
  - APPVEYOR_BUILD_WORKER_IMAGE: Visual Studio 2015
    MSSQL: SQL2012SP1
    DB_INSTANCE: localhost\SQL2012SP1

install:
  - ps: Install-Module DbaTools -Force -AllowClobber

  - echo Starting SQL Server
  - ps: >-
      $SQLInstance = $env:MSSQL;
      Start-Service "MSSQL`$$SQLInstance";

build_script:
  - git checkout master -q
  - git submodule init -q
  - git submodule update -q
  - ps: ./build/build.ps1 -SqlInstance "$env:DB_INSTANCE" -SqlLogin "$env:MSSQL_LOGIN" -SqlPass "$env:MSSQL_PASS"

after_build:
  - ps: Get-ChildItem .\db\*.bak | % { Push-AppveyorArtifact $_.FullName -FileName $_.Name }

deploy:
  release: wapo-data-police-shootings-$(Get-Date -Format "yyyyMMdd")-$(appveyor_build_version)
  description: 'Release'
  provider: GitHub
  auth_token:
    secure: VANUwPuFnS9gOTlQKMEUU2S2/y2do5xnwKFmeDDhfjUVm06fGyAdqRLhb+T2QJQz # your encrypted token from GitHub
  artifact: /.*\.bak/
  draft: false
  prerelease: false
  on:
    branch: master                 # release from master branch only
    APPVEYOR_REPO_TAG: false        # deploy on tag push only